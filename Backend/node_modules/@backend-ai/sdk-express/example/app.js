const express = require('express');
const { BackendAI } = require('../dist/index');
require('dotenv').config();

const app = express();
app.use(express.json());

// ========================================
// Sample Routes
// ========================================

// Products API
app.get('/products', (req, res) => {
    res.json({
        products: [
            { id: '1', name: 'Widget', price: 29.99 },
            { id: '2', name: 'Gadget', price: 49.99 },
        ],
    });
});

app.get('/products/:id', (req, res) => {
    const { id } = req.params;
    res.json({
        id,
        name: 'Widget',
        price: 29.99,
        stock: 100,
    });
});

app.post('/products', (req, res) => {
    const { name, price } = req.body;
    res.status(201).json({
        id: '123',
        name,
        price,
        created: true,
    });
});

// Orders API
app.post('/orders', (req, res) => {
    const { userId, items } = req.body;

    res.status(201).json({
        orderId: '42',
        userId,
        items,
        status: 'created',
        total: 99.99,
    });
});

app.get('/orders/:orderId', (req, res) => {
    const { orderId } = req.params;

    res.json({
        orderId,
        userId: '123',
        items: [],
        status: 'shipped',
        total: 99.99,
    });
});

// Users API
app.get('/users/:userId', (req, res) => {
    const { userId } = req.params;

    res.json({
        userId,
        name: 'John Doe',
        email: 'john@example.com',
    });
});

// Health check
app.get('/health', (req, res) => {
    res.json({ status: 'OK' });
});

// ========================================
// Initialize Backend AI SDK
// ========================================

(async () => {
    try {
        await BackendAI.init(app, {
            adapterId: 'example-express-app',
            tenantId: 'tenant_demo',
            coreUrl: process.env.CORE_URL || 'localhost:50051',
            executorPort: 6000,
            geminiApiKey: process.env.GEMINI_API_KEY,
            verbose: true,
        });

        // Start Express server
        const PORT = process.env.PORT || 3000;
        app.listen(PORT, () => {
            console.log(`\nðŸ“¦ Express app running on http://localhost:${PORT}`);
            console.log('ðŸ¤– Backend AI SDK is active and ready!\n');
        });
    } catch (error) {
        console.error('Failed to initialize SDK:', error);
        process.exit(1);
    }
})();

// Graceful shutdown
process.on('SIGTERM', async () => {
    console.log('\nðŸ‘‹ Shutting down gracefully...');
    await BackendAI.shutdown();
    process.exit(0);
});
